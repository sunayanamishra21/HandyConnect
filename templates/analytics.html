{% extends "base.html" %}

{% block title %}Analytics Dashboard - HandyConnect{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Analytics Dashboard</h1>
            <div>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="refreshAnalytics()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button class="btn btn-outline-success" onclick="exportAnalytics()">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Date Range Selector -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="start-date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start-date" onchange="updateDateRange()">
                    </div>
                    <div class="col-md-3">
                        <label for="end-date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end-date" onchange="updateDateRange()">
                    </div>
                    <div class="col-md-3">
                        <label for="quick-range" class="form-label">Quick Range</label>
                        <select class="form-select" id="quick-range" onchange="setQuickRange()">
                            <option value="">Select Range</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary" onclick="loadAnalytics()">
                            <i class="bi bi-search"></i> Load Analytics
                        </button>
                    </div>
                </div>
                
                <!-- Real-time Controls -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="realtime-toggle" checked onchange="toggleRealtime()">
                                <label class="form-check-label" for="realtime-toggle">
                                    <strong>Real-time Updates</strong>
                                </label>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="requestCurrentMetrics()" title="Get current metrics">
                                    <i class="bi bi-speedometer2"></i> Live Metrics
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="checkAlerts()" title="Check for alerts">
                                    <i class="bi bi-exclamation-triangle"></i> Check Alerts
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="testNotification()" title="Test notification">
                                    <i class="bi bi-bell"></i> Test Alert
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="showPerformanceStats()" title="Show performance statistics">
                                    <i class="bi bi-graph-up"></i> Performance
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="total-tasks-metric">-</h4>
                                <p class="mb-0">Total Tasks</p>
                            </div>
                            <i class="bi bi-list-task fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="avg-response-time">-</h4>
                                <p class="mb-0">Avg Response Time (min)</p>
                            </div>
                            <i class="bi bi-clock fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="escalation-rate">-</h4>
                                <p class="mb-0">Escalation Rate (%)</p>
                            </div>
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 id="satisfaction-score">-</h4>
                                <p class="mb-0">Satisfaction Score</p>
                            </div>
                            <i class="bi bi-star fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Task Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="taskStatusChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Priority Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="priorityChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Response Time Trend</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="responseTimeChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Performance Metrics</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 3 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">System Health</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="systemHealthChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Category Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 4 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Escalation Trend</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="escalationChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Socket.IO for real-time updates -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<script>
// Global variables
let charts = {};
let currentDateRange = {
    start: null,
    end: null
};

// Real-time variables
let socket = null;
let clientId = null;
let realtimeEnabled = false;
let sseEventSource = null;
let lastUpdateTime = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range (last 30 days)
    setDefaultDateRange();
    
    // Load initial analytics
    loadAnalytics();
    
    // Initialize real-time features
    initializeRealtimeFeatures();
    
    // Set up auto-refresh every 5 minutes (fallback)
    setInterval(loadAnalytics, 5 * 60 * 1000);
});

function setDefaultDateRange() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    
    currentDateRange.start = startDate.toISOString().split('T')[0];
    currentDateRange.end = endDate.toISOString().split('T')[0];
}

function setQuickRange() {
    const quickRange = document.getElementById('quick-range').value;
    if (!quickRange) return;
    
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - parseInt(quickRange));
    
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    
    updateDateRange();
}

function updateDateRange() {
    currentDateRange.start = document.getElementById('start-date').value;
    currentDateRange.end = document.getElementById('end-date').value;
}

async function loadAnalytics() {
    try {
        showLoadingIndicator();
        
        // Load analytics report
        const reportResponse = await fetch(`/api/analytics/report?start_date=${currentDateRange.start}&end_date=${currentDateRange.end}`);
        const reportData = await reportResponse.json();
        
        if (reportData.status === 'success') {
            updateMetricsCards(reportData.data);
        }
        
        // Load charts data
        const chartsResponse = await fetch(`/api/analytics/charts?start_date=${currentDateRange.start}&end_date=${currentDateRange.end}`);
        const chartsData = await chartsResponse.json();
        
        if (chartsData.status === 'success') {
            renderCharts(chartsData.data.charts);
        }
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        showNotification('Error loading analytics data', 'error');
    } finally {
        hideLoadingIndicator();
    }
}

function updateMetricsCards(data) {
    const taskAnalytics = data.task_analytics || {};
    
    // Update metric cards
    document.getElementById('total-tasks-metric').textContent = taskAnalytics.total_tasks || 0;
    document.getElementById('avg-response-time').textContent = taskAnalytics.avg_response_time_minutes || 0;
    document.getElementById('escalation-rate').textContent = taskAnalytics.escalation_rate_percent || 0;
    document.getElementById('satisfaction-score').textContent = taskAnalytics.avg_satisfaction_score || 0;
}

function renderCharts(chartsData) {
    // Task Status Chart
    if (chartsData.task_status) {
        renderChart('taskStatusChart', chartsData.task_status);
    }
    
    // Priority Distribution Chart
    if (chartsData.priority_distribution) {
        renderChart('priorityChart', chartsData.priority_distribution);
    }
    
    // Response Time Trend Chart
    if (chartsData.response_time_trend) {
        renderChart('responseTimeChart', chartsData.response_time_trend);
    }
    
    // Performance Metrics Chart
    if (chartsData.performance_metrics) {
        renderChart('performanceChart', chartsData.performance_metrics);
    }
    
    // System Health Chart
    if (chartsData.system_health) {
        renderChart('systemHealthChart', chartsData.system_health);
    }
    
    // Category Breakdown Chart
    if (chartsData.category_breakdown) {
        renderChart('categoryChart', chartsData.category_breakdown);
    }
    
    // Escalation Trend Chart
    if (chartsData.escalation_trend) {
        renderChart('escalationChart', chartsData.escalation_trend);
    }
}

function renderChart(canvasId, chartConfig) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    // Destroy existing chart if it exists
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    // Create new chart
    charts[canvasId] = new Chart(canvas, chartConfig);
}

async function refreshAnalytics() {
    await loadAnalytics();
    showNotification('Analytics refreshed successfully', 'success');
}

async function exportAnalytics() {
    try {
        showLoadingIndicator();
        
        const response = await fetch('/api/analytics/admin/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data_type: 'tasks',
                start_date: currentDateRange.start,
                end_date: currentDateRange.end
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showNotification('Analytics data exported successfully', 'success');
        } else {
            showNotification('Failed to export analytics data', 'error');
        }
        
    } catch (error) {
        console.error('Error exporting analytics:', error);
        showNotification('Error exporting analytics data', 'error');
    } finally {
        hideLoadingIndicator();
    }
}

// Utility functions (reuse from app-enhanced.js)
function showLoadingIndicator() {
    let indicator = document.getElementById('loading-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'loading-indicator';
        indicator.className = 'spinner-border text-primary polling-indicator';
        indicator.innerHTML = '<span class="visually-hidden">Loading...</span>';
        document.body.appendChild(indicator);
    }
    indicator.style.display = 'block';
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

function showNotification(message, type = 'info') {
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show notification`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// ==================== REAL-TIME FEATURES ====================

function initializeRealtimeFeatures() {
    console.log('Initializing real-time features...');
    
    // Try WebSocket first
    if (typeof io !== 'undefined') {
        initializeWebSocket();
    } else {
        console.log('Socket.IO not available, falling back to SSE');
        initializeServerSentEvents();
    }
    
    // Add real-time indicator to UI
    addRealtimeIndicator();
}

function initializeWebSocket() {
    try {
        console.log('Initializing WebSocket connection...');
        socket = io();
        
        socket.on('connect', function() {
            console.log('WebSocket connected');
            realtimeEnabled = true;
            updateRealtimeIndicator(true);
            showNotification('Real-time updates enabled', 'success');
            
            // Join dashboard room
            socket.emit('join_room', {
                room: 'dashboard',
                client_id: socket.id
            });
            
            // Subscribe to metrics
            socket.emit('subscribe_to_metrics', {
                client_id: socket.id,
                metric_types: ['all']
            });
            
            // Subscribe to alerts
            socket.emit('subscribe_to_alerts', {
                client_id: socket.id,
                alert_types: ['all']
            });
        });
        
        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
            realtimeEnabled = false;
            updateRealtimeIndicator(false);
            showNotification('Real-time updates disconnected', 'warning');
        });
        
        socket.on('dashboard_update', function(data) {
            console.log('Received dashboard update:', data);
            handleRealtimeUpdate(data);
        });
        
        socket.on('metrics_response', function(data) {
            console.log('Received metrics update:', data);
            updateMetricsFromRealtime(data.metrics);
        });
        
        socket.on('notification', function(data) {
            console.log('Received notification:', data);
            showNotification(data.message, data.type || 'info');
        });
        
        socket.on('error', function(error) {
            console.error('WebSocket error:', error);
            showNotification('Real-time connection error', 'error');
        });
        
        // Send periodic ping to keep connection alive
        setInterval(function() {
            if (socket && socket.connected) {
                socket.emit('ping', { client_id: socket.id });
            }
        }, 30000); // Ping every 30 seconds
        
    } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
        showNotification('WebSocket initialization failed, using polling', 'warning');
        initializeServerSentEvents();
    }
}

function initializeServerSentEvents() {
    try {
        console.log('Initializing Server-Sent Events...');
        sseEventSource = new EventSource('/api/realtime/dashboard/stream');
        
        sseEventSource.onopen = function(event) {
            console.log('SSE connection opened');
            realtimeEnabled = true;
            updateRealtimeIndicator(true);
            showNotification('Real-time updates enabled (SSE)', 'success');
        };
        
        sseEventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('Received SSE update:', data);
                handleRealtimeUpdate(data);
            } catch (error) {
                console.error('Error parsing SSE data:', error);
            }
        };
        
        sseEventSource.onerror = function(event) {
            console.error('SSE connection error:', event);
            realtimeEnabled = false;
            updateRealtimeIndicator(false);
            showNotification('Real-time updates disconnected (SSE)', 'warning');
            
            // Attempt to reconnect after 5 seconds
            setTimeout(function() {
                if (!realtimeEnabled) {
                    console.log('Attempting to reconnect SSE...');
                    sseEventSource.close();
                    initializeServerSentEvents();
                }
            }, 5000);
        };
        
    } catch (error) {
        console.error('Failed to initialize SSE:', error);
        showNotification('Real-time updates not available', 'warning');
    }
}

function handleRealtimeUpdate(data) {
    lastUpdateTime = new Date();
    
    switch (data.update_type) {
        case 'metrics_update':
            updateMetricsFromRealtime(data.data.metrics);
            break;
        case 'notification':
            showNotification(data.data.message, data.data.type || 'info');
            break;
        case 'alert':
            handleRealtimeAlert(data.data);
            break;
        case 'chart_update':
            updateChartFromRealtime(data.data);
            break;
        default:
            console.log('Unknown update type:', data.update_type);
    }
}

function updateMetricsFromRealtime(metrics) {
    // Update metric cards with real-time data
    if (metrics.task_count !== undefined) {
        const element = document.getElementById('total-tasks-metric');
        if (element) {
            element.textContent = metrics.task_count;
            element.style.color = '#28a745'; // Green for live data
            setTimeout(() => {
                element.style.color = '';
            }, 2000);
        }
    }
    
    if (metrics.response_time_ms !== undefined) {
        const element = document.getElementById('avg-response-time');
        if (element) {
            const minutes = Math.round(metrics.response_time_ms / 60000);
            element.textContent = minutes;
            element.style.color = metrics.response_time_ms > 60000 ? '#dc3545' : '#28a745';
            setTimeout(() => {
                element.style.color = '';
            }, 2000);
        }
    }
    
    if (metrics.error_rate !== undefined) {
        const element = document.getElementById('escalation-rate');
        if (element) {
            element.textContent = Math.round(metrics.error_rate * 100) / 100;
            element.style.color = metrics.error_rate > 5 ? '#dc3545' : '#28a745';
            setTimeout(() => {
                element.style.color = '';
            }, 2000);
        }
    }
    
    // Update system metrics if available
    if (metrics.cpu_percent !== undefined) {
        updateSystemMetric('CPU', metrics.cpu_percent, 80);
    }
    
    if (metrics.memory_percent !== undefined) {
        updateSystemMetric('Memory', metrics.memory_percent, 85);
    }
}

function updateSystemMetric(name, value, threshold) {
    // Create or update system metrics display
    let container = document.getElementById('system-metrics');
    if (!container) {
        container = document.createElement('div');
        container.id = 'system-metrics';
        container.className = 'row mb-2';
        document.querySelector('.row.mb-4').after(container);
    }
    
    let metricElement = document.getElementById(`system-${name.toLowerCase()}`);
    if (!metricElement) {
        metricElement = document.createElement('div');
        metricElement.id = `system-${name.toLowerCase()}`;
        metricElement.className = 'col-md-3';
        
        const isHigh = value > threshold;
        metricElement.innerHTML = `
            <div class="card ${isHigh ? 'bg-danger' : 'bg-secondary'} text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6>${value.toFixed(1)}%</h6>
                            <small>${name} Usage</small>
                        </div>
                        <i class="bi bi-${name.toLowerCase() === 'cpu' ? 'cpu' : 'memory'} fs-4"></i>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(metricElement);
    } else {
        const isHigh = value > threshold;
        metricElement.querySelector('.card').className = `card ${isHigh ? 'bg-danger' : 'bg-secondary'} text-white`;
        metricElement.querySelector('h6').textContent = `${value.toFixed(1)}%`;
    }
}

function handleRealtimeAlert(alertData) {
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${alertData.type === 'error' ? 'danger' : 'warning'} alert-dismissible fade show`;
    alertElement.style.position = 'fixed';
    alertElement.style.top = '80px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '9999';
    alertElement.style.minWidth = '350px';
    
    alertElement.innerHTML = `
        <strong>Alert:</strong> ${alertData.message}
        <br><small>Value: ${alertData.value} (Threshold: ${alertData.threshold})</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentNode) {
            alertElement.remove();
        }
    }, 10000); // Show alerts for 10 seconds
}

function updateChartFromRealtime(chartData) {
    // Update charts with real-time data
    Object.keys(chartData).forEach(chartName => {
        const chartConfig = chartData[chartName];
        const canvasId = chartName.replace(/_/g, '') + 'Chart';
        
        if (charts[canvasId] && chartConfig.data) {
            // Update chart data
            charts[canvasId].data = chartConfig.data;
            charts[canvasId].update('none'); // Update without animation for performance
        }
    });
}

function addRealtimeIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'realtime-indicator';
    indicator.className = 'position-fixed';
    indicator.style.top = '10px';
    indicator.style.left = '10px';
    indicator.style.zIndex = '9999';
    indicator.style.padding = '5px 10px';
    indicator.style.borderRadius = '15px';
    indicator.style.fontSize = '12px';
    indicator.style.fontWeight = 'bold';
    indicator.innerHTML = `
        <i class="bi bi-circle-fill me-1"></i>
        <span>Real-time</span>
    `;
    
    updateRealtimeIndicator(false);
    document.body.appendChild(indicator);
}

function updateRealtimeIndicator(connected) {
    const indicator = document.getElementById('realtime-indicator');
    if (indicator) {
        const icon = indicator.querySelector('i');
        const text = indicator.querySelector('span');
        
        if (connected) {
            indicator.style.backgroundColor = '#28a745';
            indicator.style.color = 'white';
            icon.className = 'bi bi-circle-fill me-1';
            text.textContent = 'Live';
        } else {
            indicator.style.backgroundColor = '#6c757d';
            indicator.style.color = 'white';
            icon.className = 'bi bi-circle-fill me-1';
            text.textContent = 'Offline';
        }
    }
}

// Enhanced refresh function with real-time awareness
async function refreshAnalytics() {
    if (realtimeEnabled) {
        showNotification('Real-time updates active - data refreshes automatically', 'info');
        return;
    }
    
    await loadAnalytics();
    showNotification('Analytics refreshed successfully', 'success');
}

// Real-time control functions
function toggleRealtime() {
    const toggle = document.getElementById('realtime-toggle');
    
    if (toggle.checked) {
        if (!realtimeEnabled) {
            initializeRealtimeFeatures();
        }
    } else {
        if (socket) {
            socket.disconnect();
        }
        if (sseEventSource) {
            sseEventSource.close();
        }
        realtimeEnabled = false;
        updateRealtimeIndicator(false);
        showNotification('Real-time updates disabled', 'info');
    }
}

async function requestCurrentMetrics() {
    try {
        const response = await fetch('/api/realtime/metrics/live');
        const data = await response.json();
        
        if (data.status === 'success') {
            updateMetricsFromRealtime(data.data.metrics);
            showNotification('Live metrics updated', 'success');
        } else {
            showNotification('Failed to get live metrics', 'error');
        }
    } catch (error) {
        console.error('Error requesting live metrics:', error);
        showNotification('Error getting live metrics', 'error');
    }
}

async function checkAlerts() {
    try {
        const response = await fetch('/api/realtime/alerts');
        const data = await response.json();
        
        if (data.status === 'success') {
            const alerts = data.data.alerts;
            if (alerts.length > 0) {
                alerts.forEach(alert => {
                    handleRealtimeAlert(alert);
                });
                showNotification(`${alerts.length} active alert(s) found`, 'warning');
            } else {
                showNotification('No active alerts', 'success');
            }
        } else {
            showNotification('Failed to check alerts', 'error');
        }
    } catch (error) {
        console.error('Error checking alerts:', error);
        showNotification('Error checking alerts', 'error');
    }
}

async function testNotification() {
    try {
        const response = await fetch('/api/realtime/notifications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'info',
                message: 'This is a test notification from the real-time dashboard',
                room: 'dashboard'
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Test notification sent successfully', 'success');
        } else {
            showNotification('Failed to send test notification', 'error');
        }
    } catch (error) {
        console.error('Error sending test notification:', error);
        showNotification('Error sending test notification', 'error');
    }
}

async function showPerformanceStats() {
    try {
        const response = await fetch('/api/realtime/performance/stats');
        const data = await response.json();
        
        if (data.status === 'success') {
            displayPerformanceModal(data.data);
        } else {
            showNotification('Failed to get performance stats', 'error');
        }
    } catch (error) {
        console.error('Error getting performance stats:', error);
        showNotification('Error getting performance stats', 'error');
    }
}

function displayPerformanceModal(stats) {
    // Create modal for performance stats
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'performanceModal';
    modal.tabIndex = -1;
    
    const cacheStats = stats.cache;
    const performanceStats = stats.performance;
    
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dashboard Performance Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Cache Performance</h6>
                            <table class="table table-sm">
                                <tr><td>Hit Rate</td><td><span class="badge bg-success">${cacheStats.hit_rate_percent}%</span></td></tr>
                                <tr><td>Cache Hits</td><td>${cacheStats.hits}</td></tr>
                                <tr><td>Cache Misses</td><td>${cacheStats.misses}</td></tr>
                                <tr><td>Cache Size</td><td>${cacheStats.cache_size}/${cacheStats.max_size}</td></tr>
                                <tr><td>Utilization</td><td>${cacheStats.utilization_percent}%</td></tr>
                                <tr><td>Evictions</td><td>${cacheStats.evictions}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>System Performance</h6>
                            <table class="table table-sm">
                                <tr><td>Active Connections</td><td>${performanceStats.active_connections}</td></tr>
                                <tr><td>Data Throughput</td><td>${formatBytes(performanceStats.data_throughput_bytes)}</td></tr>
                                <tr><td>Error Count</td><td>${Object.keys(performanceStats.error_counts).length}</td></tr>
                            </table>
                            
                            <h6>Average Request Times</h6>
                            <table class="table table-sm">
                                ${Object.entries(performanceStats.average_request_times).map(([endpoint, time]) => 
                                    `<tr><td>${endpoint}</td><td>${time}ms</td></tr>`
                                ).join('')}
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="clearCache()">Clear Cache</button>
                    <button type="button" class="btn btn-primary" onclick="preloadCache()">Preload Cache</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal when hidden
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

async function clearCache() {
    try {
        const response = await fetch('/api/realtime/cache/clear', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Cache cleared successfully', 'success');
        } else {
            showNotification('Failed to clear cache', 'error');
        }
    } catch (error) {
        console.error('Error clearing cache:', error);
        showNotification('Error clearing cache', 'error');
    }
}

async function preloadCache() {
    try {
        const response = await fetch('/api/realtime/cache/preload', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Cache preloaded successfully', 'success');
        } else {
            showNotification('Failed to preload cache', 'error');
        }
    } catch (error) {
        console.error('Error preloading cache:', error);
        showNotification('Error preloading cache', 'error');
    }
}

// Cleanup function
window.addEventListener('beforeunload', function() {
    if (socket) {
        socket.disconnect();
    }
    if (sseEventSource) {
        sseEventSource.close();
    }
});
</script>
{% endblock %}
